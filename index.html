<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>bchat - æç®€ç§èŠ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        }
        body {
            background: #f5f5f5;
            color: #333;
            display: flex;
            height: 100vh;
        }
        .sidebar {
            width: 280px;
            background: #fff;
            border-right: 1px solid #eee;
            display: flex;
            flex-direction: column;
        }
        .sidebar-header {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        .sidebar-header h1 {
            font-size: 24px;
            color: #2196F3;
        }
        .contact-list {
            flex: 1;
            overflow-y: auto;
        }
        .contact-item {
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.2s;
        }
        .contact-item:hover {
            background: #f8f8f8;
        }
        .contact-item.active {
            background: #e3f2fd;
        }
        .contact-name {
            font-weight: 500;
            margin-bottom: 4px;
        }
        .contact-lastmsg {
            font-size: 13px;
            color: #888;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #fff;
        }
        .chat-header {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            background: #fafafa;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-header h2 {
            font-size: 18px;
        }
        .chat-empty {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
            font-size: 16px;
            background: #fafafa;
        }
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background: #fafafa;
            display: none;
        }
        .message {
            max-width: 70%;
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 18px;
            line-height: 1.5;
            position: relative;
        }
        .message.sent {
            background: #2196F3;
            color: #fff;
            margin-left: auto;
            border-bottom-right-radius: 4px;
        }
        .message.received {
            background: #e0e0e0;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 4px;
        }
        .message-time {
            font-size: 11px;
            color: rgba(0,0,0,0.4);
            margin-top: 5px;
            text-align: right;
        }
        .message-file {
            display: block;
            margin-top: 8px;
            color: inherit;
            text-decoration: none;
            background: rgba(0,0,0,0.1);
            padding: 8px;
            border-radius: 8px;
            word-break: break-all;
        }
        .message-delete {
            position: absolute;
            top: 5px;
            right: 5px;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: rgba(0,0,0,0.2);
            color: white;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .message:hover .message-delete {
            opacity: 1;
        }
        .chat-input-area {
            padding: 15px;
            border-top: 1px solid #eee;
            background: #fff;
            display: flex;
            gap: 10px;
            display: none;
        }
        .chat-input {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 24px;
            outline: none;
            resize: none;
            min-height: 48px;
            max-height: 120px;
        }
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 24px;
            cursor: pointer;
            font-weight: 500;
            transition: background 0.2s;
        }
        .btn-primary {
            background: #2196F3;
            color: #fff;
        }
        .btn-primary:hover {
            background: #1976D2;
        }
        .btn-file {
            background: #f0f0f0;
            color: #666;
        }
        .btn-file:hover {
            background: #e0e0e0;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .modal-content {
            background: #fff;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            max-height: 80vh;
            overflow-y: auto;
        }
        .modal-title {
            font-size: 20px;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
        }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .modal-actions {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 20px;
        }
        .upload-progress {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #fff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: none;
            z-index: 1000;
        }
        .progress-bar {
            width: 200px;
            height: 8px;
            background: #eee;
            border-radius: 4px;
            margin-top: 8px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: #2196F3;
            width: 0%;
            transition: width 0.3s ease;
        }
        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255,255,255,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            font-size: 18px;
            color: #2196F3;
        }
        .contact-item.file-transfer {
            background: #f0f8ff;
        }
        .contact-item.file-transfer:hover {
            background: #e8f4f8;
        }
        .btn-clear {
            padding: 8px 12px;
            font-size: 14px;
            background: #f44336;
            color: white;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }
        .btn-clear:hover {
            background: #d32f2f;
        }
        .refresh-btn {
            padding: 8px 12px;
            font-size: 14px;
            background: #4CAF50;
            color: white;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }
        .refresh-btn:hover {
            background: #388E3C;
        }
        .my-profile-section {
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .my-profile-info {
            display: flex;
            flex-direction: column;
        }
        .my-username {
            font-weight: 500;
            font-size: 16px;
            color: #2196F3;
        }
        .edit-profile-btn {
            font-size: 12px;
            color: #2196F3;
            cursor: pointer;
            text-decoration: underline;
        }
        .contact-remark {
            font-size: 12px;
            color: #666;
            margin-top: 2px;
        }
        .remark-edit-btn {
            font-size: 11px;
            color: #2196F3;
            cursor: pointer;
            margin-left: 5px;
        }
        /* æ–°å¢ï¼šè®¾ç½®æŒ‰é’®æ ·å¼ */
        .settings-btn {
            padding: 8px 12px;
            font-size: 14px;
            background: #9e9e9e;
            color: white;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            margin-right: 10px;
        }
        .settings-btn:hover {
            background: #757575;
        }
        /* æ–°å¢ï¼šè®¾ç½®é¡¹æ ·å¼ */
        .settings-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        .settings-section:last-child {
            border-bottom: none;
        }
        .settings-label {
            font-weight: 500;
            margin-bottom: 10px;
            display: block;
        }
        .settings-desc {
            font-size: 13px;
            color: #666;
            margin-bottom: 10px;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 24px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:checked + .slider:before {
            transform: translateX(26px);
        }
        .password-strength {
            font-size: 12px;
            margin-top: 5px;
            height: 20px;
        }
        .strength-weak { color: #f44336; }
        .strength-medium { color: #ff9800; }
        .strength-strong { color: #4caf50; }
        .file-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #eee;
            border-radius: 8px;
            padding: 10px;
        }
        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            border-bottom: 1px solid #f0f0f0;
        }
        .file-item:last-child {
            border-bottom: none;
        }
        .file-info {
            flex: 1;
            overflow: hidden;
        }
        .file-name {
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .file-meta {
            font-size: 12px;
            color: #888;
        }
        .file-actions {
            display: flex;
            gap: 5px;
        }
        .btn-small {
            padding: 4px 8px;
            font-size: 12px;
            border-radius: 4px;
            border: none;
            cursor: pointer;
        }
        .btn-danger {
            background: #f44336;
            color: white;
        }
        .btn-danger:hover {
            background: #d32f2f;
        }
        .danger-zone {
            background: #ffebee;
            border: 1px solid #f44336;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .danger-title {
            color: #f44336;
            font-weight: 500;
            margin-bottom: 10px;
        }
        .verify-ip-box {
            background: #e3f2fd;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            font-family: monospace;
            text-align: center;
        }
    </style>
</head>
<body>
    <div class="loading" id="loading">æ­£åœ¨è·å–å¤–ç½‘IPå¹¶éªŒè¯èº«ä»½...</div>

    <div class="sidebar">
        <div class="sidebar-header">
            <h1>bchat</h1>
            <p style="font-size: 13px; color: #888; margin-top: 5px;">ä½ çš„å¤–ç½‘IP: <span id="my-ip">åŠ è½½ä¸­...</span></p>
        </div>
        
        <div class="my-profile-section">
            <div class="my-profile-info">
                <div class="my-username" id="my-username">æœªè®¾ç½®ç”¨æˆ·å</div>
                <span class="edit-profile-btn" onclick="openEditProfileModal()">ç¼–è¾‘èµ„æ–™</span>
            </div>
        </div>

        <div class="contact-list" id="contact-list">
            <!-- è”ç³»äººåˆ—è¡¨åŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div style="padding: 15px; border-top: 1px solid #eee;">
            <button class="btn btn-primary" style="width: 100%; margin-bottom: 8px;" onclick="openAddContactModal()">+ æ·»åŠ è”ç³»äºº</button>
            <button class="btn" style="width: 100%; background: #f0f0f0; color: #666;" onclick="openSettingsModal()">âš™ï¸ è®¾ç½®</button>
        </div>
    </div>

    <div class="main">
        <div class="chat-header">
            <h2 id="chat-title">è¯·é€‰æ‹©è”ç³»äººå¼€å§‹èŠå¤©</h2>
            <div>
                <button class="refresh-btn" id="refresh-chat-btn" style="display: none;" onclick="loadMessages()">ğŸ”„ åˆ·æ–°æ¶ˆæ¯</button>
                <button class="btn-clear" id="clear-chat-btn" style="display: none;" onclick="clearChatHistory()">æ¸…ç©ºèŠå¤©è®°å½•</button>
            </div>
        </div>
        <div class="chat-empty" id="chat-empty">
            æš‚æ— èŠå¤©å¯¹è±¡ï¼Œè¯·æ·»åŠ è”ç³»äººæˆ–é€‰æ‹©æ–‡ä»¶ä¼ è¾“åŠ©æ‰‹
        </div>
        <div class="chat-messages" id="chat-messages">
            <!-- æ¶ˆæ¯å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
        </div>
        <div class="chat-input-area" id="chat-input-area">
            <textarea class="chat-input" id="message-input" placeholder="è¾“å…¥æ¶ˆæ¯..." rows="1"></textarea>
            <button class="btn btn-file" onclick="document.getElementById('file-input').click()">ğŸ“</button>
            <input type="file" id="file-input" style="display: none" accept="*">
            <button class="btn btn-primary" id="send-btn">å‘é€</button>
        </div>
    </div>

    <!-- æ·»åŠ è”ç³»äººå¼¹çª— -->
    <div class="modal" id="add-contact-modal">
        <div class="modal-content">
            <div class="modal-title">æ·»åŠ è”ç³»äºº</div>
            <div class="form-group">
                <label for="contact-ip">å¯¹æ–¹å¤–ç½‘IPåœ°å€</label>
                <input type="text" class="form-control" id="contact-ip" placeholder="ä¾‹å¦‚: 114.114.114.114">
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeAddContactModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="sendContactRequest()">å‘é€ç”³è¯·</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘ä¸ªäººèµ„æ–™å¼¹çª— -->
    <div class="modal" id="edit-profile-modal">
        <div class="modal-content">
            <div class="modal-title">ç¼–è¾‘ä¸ªäººèµ„æ–™</div>
            <div class="form-group">
                <label for="new-username">è®¾ç½®ç”¨æˆ·å</label>
                <input type="text" class="form-control" id="new-username" placeholder="æœ€å¤š20ä¸ªå­—ç¬¦" maxlength="20">
                <small style="color: #888; margin-top: 5px; display: block;" id="username-length-tip">0/20 å­—ç¬¦</small>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeEditProfileModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveUsername()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- ç¼–è¾‘è”ç³»äººå¤‡æ³¨å¼¹çª— -->
    <div class="modal" id="edit-remark-modal">
        <div class="modal-content">
            <div class="modal-title">ç¼–è¾‘è”ç³»äººå¤‡æ³¨</div>
            <div class="form-group">
                <label for="contact-ip-display">è”ç³»äººIP</label>
                <input type="text" class="form-control" id="contact-ip-display" readonly>
            </div>
            <div class="form-group">
                <label for="contact-remark-input">å¤‡æ³¨åç§°</label>
                <input type="text" class="form-control" id="contact-remark-input" placeholder="æœ€å¤š20ä¸ªå­—ç¬¦" maxlength="20">
                <small style="color: #888; margin-top: 5px; display: block;" id="remark-length-tip">0/20 å­—ç¬¦</small>
            </div>
            <div class="modal-actions">
                <button class="btn" onclick="closeEditRemarkModal()">å–æ¶ˆ</button>
                <button class="btn btn-primary" onclick="saveContactRemark()">ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ï¼šè®¾ç½®å¼¹çª— -->
    <div class="modal" id="settings-modal">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-title">è®¾ç½®</div>
            
            <!-- ç™»å½•å¯†ç è®¾ç½® -->
            <div class="settings-section">
                <label class="settings-label">ç™»å½•å¯†ç ä¿æŠ¤</label>
                <p class="settings-desc">å¼€å¯åï¼Œæ¯æ¬¡æ‰“å¼€åº”ç”¨éœ€è¦è¾“å…¥å¯†ç éªŒè¯èº«ä»½</p>
                <label class="toggle-switch">
                    <input type="checkbox" id="password-toggle" onchange="togglePasswordProtection()">
                    <span class="slider"></span>
                </label>
                <div id="password-setup-panel" style="display: none; margin-top: 15px;">
                    <div class="form-group">
                        <label>è®¾ç½®å¯†ç  (8-22ä½ï¼Œå¿…é¡»åŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦)</label>
                        <input type="password" class="form-control" id="new-password" placeholder="è¾“å…¥å¯†ç " oninput="checkPasswordStrength()">
                        <div class="password-strength" id="password-strength"></div>
                    </div>
                    <div class="form-group">
                        <input type="password" class="form-control" id="confirm-password" placeholder="ç¡®è®¤å¯†ç ">
                    </div>
                    <button class="btn btn-primary" onclick="savePassword()">ä¿å­˜å¯†ç </button>
                </div>
                <div id="password-status" style="margin-top: 10px; font-size: 13px; color: #4caf50;"></div>
            </div>

            <!-- äº‘ç«¯æ–‡ä»¶ç®¡ç† -->
            <div class="settings-section">
                <label class="settings-label">äº‘ç«¯æ–‡ä»¶ç®¡ç†</label>
                <p class="settings-desc">æŸ¥çœ‹å’Œç®¡ç†ä½ ä¸Šä¼ çš„æ‰€æœ‰æ–‡ä»¶</p>
                <button class="btn btn-primary" onclick="loadCloudFiles()">åˆ·æ–°æ–‡ä»¶åˆ—è¡¨</button>
                <div class="file-list" id="cloud-files-list" style="margin-top: 10px;">
                    <div style="text-align: center; color: #888; padding: 20px;">ç‚¹å‡»åˆ·æ–°åŠ è½½æ–‡ä»¶åˆ—è¡¨</div>
                </div>
            </div>

            <!-- æ³¨é”€è´¦æˆ· -->
            <div class="danger-zone">
                <div class="danger-title">âš ï¸ å±é™©åŒºåŸŸ</div>
                <p class="settings-desc">æ³¨é”€è´¦æˆ·å°†æ°¸ä¹…åˆ é™¤ä½ çš„æ‰€æœ‰æ•°æ®ï¼ŒåŒ…æ‹¬è”ç³»äººã€èŠå¤©è®°å½•å’Œä¸Šä¼ çš„æ–‡ä»¶ã€‚æ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚</p>
                <button class="btn btn-danger" onclick="startAccountDeletion()">æ³¨é”€è´¦æˆ·</button>
            </div>

            <div class="modal-actions">
                <button class="btn" onclick="closeSettingsModal()">å…³é—­</button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ï¼šå¯†ç éªŒè¯å¼¹çª— -->
    <div class="modal" id="password-verify-modal">
        <div class="modal-content">
            <div class="modal-title">èº«ä»½éªŒè¯</div>
            <p style="margin-bottom: 15px; color: #666;">è¯¥è´¦æˆ·å·²å¯ç”¨å¯†ç ä¿æŠ¤ï¼Œè¯·è¾“å…¥å¯†ç ç»§ç»­</p>
            <div class="form-group">
                <input type="password" class="form-control" id="verify-password" placeholder="è¾“å…¥å¯†ç " onkeydown="if(event.key==='Enter') verifyPassword()">
            </div>
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="verifyPassword()">éªŒè¯</button>
            </div>
        </div>
    </div>

    <!-- æ–°å¢ï¼šæ³¨é”€ç¡®è®¤å¼¹çª— -->
    <div class="modal" id="delete-account-modal">
        <div class="modal-content">
            <div class="modal-title" style="color: #f44336;">ç¡®è®¤æ³¨é”€è´¦æˆ·</div>
            <p style="margin-bottom: 15px;">è¯·è¾“å…¥ä»¥ä¸‹IPåœ°å€ä»¥ç¡®è®¤æ³¨é”€ï¼š</p>
            <div class="verify-ip-box" id="verify-ip-display"></div>
            <div class="form-group">
                <input type="text" class="form-control" id="verify-ip-input" placeholder="è¾“å…¥ä¸Šæ–¹IPåœ°å€">
            </div>
            <p style="color: #f44336; font-size: 13px; margin-bottom: 15px;">è­¦å‘Šï¼šæ­¤æ“ä½œå°†æ°¸ä¹…åˆ é™¤æ‰€æœ‰æ•°æ®ï¼Œæ— æ³•æ¢å¤ï¼</p>
            <div class="modal-actions">
                <button class="btn" onclick="closeDeleteAccountModal()">å–æ¶ˆ</button>
                <button class="btn btn-danger" onclick="confirmDeleteAccount()">ç¡®è®¤æ³¨é”€</button>
            </div>
        </div>
    </div>

    <div class="upload-progress" id="upload-progress">
        <div>ä¸Šä¼ ä¸­...</div>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
    </div>

    <script>
        // é…ç½®ä¿¡æ¯
        const CONFIG = {
            endpoint: 'cn-sy1.rains3.com',
            accessKey: 'bvduoispWIlcPnvI',
            secretKey: 'RZvk3cDwSXU0Cym8ly46Z0bi9gkN0J',
            bucket: 'bchat',
            region: 'cn-sy1',
            maxImageSize: 3 * 1024 * 1024,
            maxFileSize: 2 * 1024 * 1024 * 1024,
            accountInactiveDays: 90,
            fileTransferKey: 'file-transfer',
            // ä¿®æ”¹ä¸ºä»…IPv4çš„API
            ipApiList: [
                'https://api4.ipify.org?format=json',
                'https://ipv4.icanhazip.com',
                'https://v4.ident.me/.json'
            ],
            messageSyncInterval: 5000,
            maxUsernameLength: 20,
            maxRemarkLength: 20,
            // PBKDF2é…ç½®
            pbkdf2Iterations: 100000,
            pbkdf2KeyLength: 32
        };

        let myIp = '';
        let currentChat = '';
        let contacts = [];
        let pendingRequests = [];
        let messageSyncTimer = null;
        let myUsername = '';
        let userPasswordHash = null; // å­˜å‚¨å¯†ç å“ˆå¸Œ
        let isPasswordProtected = false;

        // åˆå§‹åŒ–
        async function init() {
            try {
                // å¼ºåˆ¶è·å–IPv4åœ°å€
                myIp = await getIPv4Address();
                if (!myIp || isPrivateIp(myIp)) {
                    throw new Error('æ— æ³•è·å–æœ‰æ•ˆçš„IPv4å¤–ç½‘åœ°å€ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
                }
                document.getElementById('my-ip').textContent = myIp;
                
                await checkAccountRegistration();
                
                // æ£€æŸ¥å¯†ç ä¿æŠ¤
                if (await checkPasswordProtection()) {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('password-verify-modal').style.display = 'flex';
                    return; // ç­‰å¾…å¯†ç éªŒè¯
                }
                
                checkAccountInactive();
                await loadMyUsername();
                updateUsernameDisplay();
                renderContactList();
                setupEventListeners();
                setupLengthListeners();
                document.getElementById('loading').style.display = 'none';
            } catch (error) {
                alert(`åˆå§‹åŒ–å¤±è´¥: ${error.message}`);
                console.error('åˆå§‹åŒ–é”™è¯¯:', error);
                document.getElementById('loading').style.display = 'none';
            }
        }

        // ===== ä¼˜åŒ–ï¼šä»…è·å–IPv4åœ°å€ =====
        function isPrivateIp(ip) {
            const ipParts = ip.split('.').map(Number);
            return (
                ipParts[0] === 10 ||
                (ipParts[0] === 172 && ipParts[1] >= 16 && ipParts[1] <= 31) ||
                (ipParts[0] === 192 && ipParts[1] === 168) ||
                ipParts[0] === 127 ||
                ip === '0.0.0.0'
            );
        }

        // éªŒè¯æ˜¯å¦ä¸ºIPv4æ ¼å¼
        function isIPv4(ip) {
            const ipv4Regex = /^(\d{1,3}\.){3}\d{1,3}$/;
            if (!ipv4Regex.test(ip)) return false;
            const parts = ip.split('.');
            return parts.every(part => {
                const num = parseInt(part, 10);
                return num >= 0 && num <= 255;
            });
        }

        async function getIPv4Address(retries = 3) {
            for (let i = 0; i < CONFIG.ipApiList.length; i++) {
                try {
                    const api = CONFIG.ipApiList[i];
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000);
                    
                    let response = await fetch(api, { 
                        signal: controller.signal,
                        headers: { 'Accept': 'application/json' }
                    });
                    clearTimeout(timeoutId);
                    
                    if (!response.ok) continue;
                    
                    let data;
                    let ip;
                    
                    if (api.includes('icanhazip') || api.includes('ident.me')) {
                        // çº¯æ–‡æœ¬æˆ–JSON
                        const text = await response.text();
                        try {
                            data = JSON.parse(text);
                            ip = data.ip || data.address;
                        } catch {
                            ip = text.trim();
                        }
                    } else {
                        data = await response.json();
                        ip = data.ip;
                    }
                    
                    // ä¸¥æ ¼éªŒè¯IPv4æ ¼å¼
                    if (ip && isIPv4(ip) && !isPrivateIp(ip)) {
                        return ip;
                    }
                } catch (e) {
                    console.log(`IPv4æ¥å£ ${CONFIG.ipApiList[i]} è°ƒç”¨å¤±è´¥:`, e);
                    continue;
                }
            }
            
            if (retries > 0) {
                await new Promise(resolve => setTimeout(resolve, 1000));
                return getIPv4Address(retries - 1);
            }
            
            return '';
        }

        // æ£€æŸ¥è´¦æˆ·æ˜¯å¦å·²æ³¨å†Œ
        async function checkAccountRegistration() {
            try {
                const userDataKey = `users/${myIp}/user_data.json`;
                const userDataUrl = `https://${CONFIG.bucket}.${CONFIG.endpoint}/${userDataKey}`;
                const response = await fetch(userDataUrl);
                if (response.ok) {
                    const data = await response.json();
                    if (Array.isArray(data.contacts) && data.contacts.length > 0) {
                        if (typeof data.contacts[0] === 'string') {
                            contacts = data.contacts.map(ip => ({ ip, remark: '' }));
                        } else {
                            contacts = data.contacts;
                        }
                    } else {
                        contacts = [];
                    }
                    pendingRequests = data.pendingRequests || [];
                    myUsername = data.username || '';
                    userPasswordHash = data.passwordHash || null;
                    isPasswordProtected = !!userPasswordHash;
                } else {
                    await createNewAccount();
                }
            } catch (error) {
                await createNewAccount();
            }
        }

        // æ£€æŸ¥æ˜¯å¦éœ€è¦å¯†ç éªŒè¯
        async function checkPasswordProtection() {
            return isPasswordProtected;
        }

        // éªŒè¯å¯†ç 
        async function verifyPassword() {
            const inputPassword = document.getElementById('verify-password').value;
            if (!inputPassword) {
                alert('è¯·è¾“å…¥å¯†ç ');
                return;
            }
            
            try {
                const isValid = await verifyPBKDF2(inputPassword, userPasswordHash);
                if (isValid) {
                    document.getElementById('password-verify-modal').style.display = 'none';
                    document.getElementById('loading').style.display = 'flex';
                    
                    checkAccountInactive();
                    await loadMyUsername();
                    updateUsernameDisplay();
                    renderContactList();
                    setupEventListeners();
                    setupLengthListeners();
                    
                    document.getElementById('loading').style.display = 'none';
                } else {
                    alert('å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•');
                    document.getElementById('verify-password').value = '';
                }
            } catch (error) {
                alert('éªŒè¯å¤±è´¥: ' + error.message);
            }
        }

        // åˆ›å»ºæ–°è´¦æˆ·
        async function createNewAccount() {
            const userData = {
                contacts: [],
                pendingRequests: [],
                lastActive: Date.now(),
                createTime: Date.now(),
                username: '',
                passwordHash: null
            };
            await uploadDataToRains3(`users/${myIp}/user_data.json`, userData);
            contacts = [];
            pendingRequests = [];
            myUsername = '';
            userPasswordHash = null;
            isPasswordProtected = false;
        }

        // åŠ è½½ç”¨æˆ·æ•°æ®
        async function loadUserData() {
            const userDataKey = `users/${myIp}/user_data.json`;
            const userDataUrl = `https://${CONFIG.bucket}.${CONFIG.endpoint}/${userDataKey}`;
            const response = await fetch(userDataUrl);
            if (response.ok) {
                return await response.json();
            }
            return { contacts: [], pendingRequests: [], lastActive: Date.now(), username: '', passwordHash: null };
        }

        // ä¿å­˜ç”¨æˆ·æ•°æ®
        async function saveUserData() {
            const userData = {
                contacts,
                pendingRequests,
                lastActive: Date.now(),
                username: myUsername,
                passwordHash: userPasswordHash
            };
            await uploadDataToRains3(`users/${myIp}/user_data.json`, userData);
        }

        // æ£€æŸ¥è´¦æˆ·æ˜¯å¦è¶…è¿‡90å¤©æœªç™»å½•
        async function checkAccountInactive() {
            const userData = await loadUserData();
            const lastActive = userData.lastActive || 0;
            const daysInactive = (Date.now() - lastActive) / (1000 * 60 * 60 * 24);
            if (daysInactive > CONFIG.accountInactiveDays) {
                await deleteFromRains3(`users/${myIp}/user_data.json`).catch(() => {});
                contacts = [];
                pendingRequests = [];
                myUsername = '';
                userPasswordHash = null;
                isPasswordProtected = false;
                alert('è´¦æˆ·å› è¶…è¿‡90å¤©æœªç™»å½•å·²è¢«é‡ç½®ï¼ŒèŠå¤©è®°å½•ä»ä¿ç•™');
                await createNewAccount();
            } else {
                await saveUserData();
            }
        }

        // ===== PBKDF2 æ…¢å“ˆå¸Œå®ç° =====
        async function hashPBKDF2(password) {
            // ç”Ÿæˆéšæœºç› (16å­—èŠ‚)
            const salt = crypto.getRandomValues(new Uint8Array(16));
            const encoder = new TextEncoder();
            const passwordData = encoder.encode(password);
            
            // å¯¼å…¥å¯†é’¥
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                passwordData,
                { name: 'PBKDF2' },
                false,
                ['deriveBits']
            );
            
            // æ´¾ç”Ÿå¯†é’¥
            const derivedBits = await crypto.subtle.deriveBits(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: CONFIG.pbkdf2Iterations,
                    hash: 'SHA-256'
                },
                keyMaterial,
                CONFIG.pbkdf2KeyLength * 8
            );
            
            const hashArray = new Uint8Array(derivedBits);
            
            // æ ¼å¼: pbkdf2$iterations$salt$hash
            const saltHex = Array.from(salt).map(b => b.toString(16).padStart(2, '0')).join('');
            const hashHex = Array.from(hashArray).map(b => b.toString(16).padStart(2, '0')).join('');
            
            return `pbkdf2$${CONFIG.pbkdf2Iterations}$${saltHex}$${hashHex}`;
        }

        async function verifyPBKDF2(password, storedHash) {
            const parts = storedHash.split('$');
            if (parts.length !== 4 || parts[0] !== 'pbkdf2') {
                throw new Error('æ— æ•ˆçš„å“ˆå¸Œæ ¼å¼');
            }
            
            const iterations = parseInt(parts[1]);
            const saltHex = parts[2];
            const storedHashHex = parts[3];
            
            const salt = new Uint8Array(saltHex.match(/.{2}/g).map(byte => parseInt(byte, 16)));
            const encoder = new TextEncoder();
            const passwordData = encoder.encode(password);
            
            const keyMaterial = await crypto.subtle.importKey(
                'raw',
                passwordData,
                { name: 'PBKDF2' },
                false,
                ['deriveBits']
            );
            
            const derivedBits = await crypto.subtle.deriveBits(
                {
                    name: 'PBKDF2',
                    salt: salt,
                    iterations: iterations,
                    hash: 'SHA-256'
                },
                keyMaterial,
                storedHashHex.length * 4 // åå…­è¿›åˆ¶é•¿åº¦è½¬æ¯”ç‰¹
            );
            
            const hashArray = new Uint8Array(derivedBits);
            const hashHex = Array.from(hashArray).map(b => b.toString(16).padStart(2, '0')).join('');
            
            // å¸¸é‡æ—¶é—´æ¯”è¾ƒ
            if (hashHex.length !== storedHashHex.length) return false;
            let result = 0;
            for (let i = 0; i < hashHex.length; i++) {
                result |= hashHex.charCodeAt(i) ^ storedHashHex.charCodeAt(i);
            }
            return result === 0;
        }

        // ===== è®¾ç½®æ¨¡å—åŠŸèƒ½ =====
        function openSettingsModal() {
            document.getElementById('settings-modal').style.display = 'flex';
            // åŒæ­¥å¯†ç ä¿æŠ¤çŠ¶æ€
            document.getElementById('password-toggle').checked = isPasswordProtected;
            togglePasswordProtection();
            if (isPasswordProtected) {
                document.getElementById('password-status').textContent = 'å¯†ç ä¿æŠ¤å·²å¯ç”¨';
            }
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        function togglePasswordProtection() {
            const isEnabled = document.getElementById('password-toggle').checked;
            const panel = document.getElementById('password-setup-panel');
            if (isEnabled && !isPasswordProtected) {
                panel.style.display = 'block';
            } else if (isEnabled && isPasswordProtected) {
                panel.style.display = 'none';
                document.getElementById('password-status').textContent = 'å¯†ç ä¿æŠ¤å·²å¯ç”¨';
            } else {
                panel.style.display = 'none';
                document.getElementById('password-status').textContent = '';
            }
        }

        function checkPasswordStrength() {
            const password = document.getElementById('new-password').value;
            const strengthEl = document.getElementById('password-strength');
            
            // å¯†ç è¦æ±‚ï¼š8-22ä½ï¼ŒåŒ…å«å¤§å°å†™å­—æ¯ã€æ•°å­—ã€ç‰¹æ®Šå­—ç¬¦
            const hasLower = /[a-z]/.test(password);
            const hasUpper = /[A-Z]/.test(password);
            const hasNumber = /\d/.test(password);
            const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
            const lengthValid = password.length >= 8 && password.length <= 22;
            
            let strength = 0;
            if (hasLower) strength++;
            if (hasUpper) strength++;
            if (hasNumber) strength++;
            if (hasSpecial) strength++;
            
            if (password.length === 0) {
                strengthEl.textContent = '';
                strengthEl.className = 'password-strength';
            } else if (!lengthValid) {
                strengthEl.textContent = 'å¯†ç é•¿åº¦å¿…é¡»åœ¨8-22ä½ä¹‹é—´';
                strengthEl.className = 'password-strength strength-weak';
            } else if (strength < 4) {
                strengthEl.textContent = 'å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯ã€å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦';
                strengthEl.className = 'password-strength strength-weak';
            } else {
                strengthEl.textContent = 'å¯†ç å¼ºåº¦: å¼º';
                strengthEl.className = 'password-strength strength-strong';
            }
        }

        async function savePassword() {
            const password = document.getElementById('new-password').value;
            const confirmPassword = document.getElementById('confirm-password').value;
            
            // éªŒè¯å¯†ç 
            const hasLower = /[a-z]/.test(password);
            const hasUpper = /[A-Z]/.test(password);
            const hasNumber = /\d/.test(password);
            const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(password);
            
            if (password.length < 8 || password.length > 22) {
                alert('å¯†ç é•¿åº¦å¿…é¡»åœ¨8-22ä½ä¹‹é—´');
                return;
            }
            if (!hasLower || !hasUpper || !hasNumber || !hasSpecial) {
                alert('å¯†ç å¿…é¡»åŒ…å«å¤§å†™å­—æ¯ã€å°å†™å­—æ¯ã€æ•°å­—å’Œç‰¹æ®Šå­—ç¬¦');
                return;
            }
            if (password !== confirmPassword) {
                alert('ä¸¤æ¬¡è¾“å…¥çš„å¯†ç ä¸ä¸€è‡´');
                return;
            }
            
            try {
                const hash = await hashPBKDF2(password);
                userPasswordHash = hash;
                isPasswordProtected = true;
                await saveUserData();
                document.getElementById('password-status').textContent = 'å¯†ç ä¿æŠ¤å·²å¯ç”¨';
                document.getElementById('password-setup-panel').style.display = 'none';
                alert('å¯†ç è®¾ç½®æˆåŠŸï¼ä¸‹æ¬¡æ‰“å¼€åº”ç”¨æ—¶éœ€è¦éªŒè¯');
            } catch (error) {
                alert('è®¾ç½®å¯†ç å¤±è´¥: ' + error.message);
            }
        }

        // ===== ä¿®å¤åçš„ ListObjects API å®ç° =====
        async function listObjectsFromRains3(prefix) {
            const maxKeys = 1000;
            const isoDate = getISO8601Date();
            
            // æ„å»º query å‚æ•°ï¼ˆå¿…é¡»æŒ‰å­—æ¯é¡ºåºæ’åºï¼‰
            const queryParams = {
                'list-type': '2',
                'max-keys': maxKeys.toString(),
                'prefix': prefix
            };
            
            // æŒ‰å­—æ¯é¡ºåºæ’åºå¹¶æ„å»ºæŸ¥è¯¢å­—ç¬¦ä¸²
            const sortedKeys = Object.keys(queryParams).sort();
            const queryStringParts = sortedKeys.map(key => {
                // å¯¹ key å’Œ value è¿›è¡Œ URI ç¼–ç ï¼Œå¹¶æ›¿æ¢ + ä¸º %20ï¼Œæ›¿æ¢ * ä¸º %2A ç­‰
                const encodedKey = encodeURIComponent(key);
                const encodedValue = encodeURIComponent(queryParams[key]).replace(/%20/g, '+');
                return `${encodedKey}=${encodedValue}`;
            });
            const canonicalQueryString = queryStringParts.join('&');
            
            // å¯¹äº ListObjectsï¼ŒCanonical URI æ˜¯ /ï¼ˆæ ¹è·¯å¾„ï¼‰
            const canonicalUri = '/';
            
            // è®¡ç®—ç©ºå†…å®¹çš„ SHA256ï¼ˆGET è¯·æ±‚æ²¡æœ‰ bodyï¼‰
            const payloadHash = uint8ArrayToHex(await sha256(''));
            
            // æ„å»º Canonical Headersï¼ˆå¿…é¡»æŒ‰å­—æ¯é¡ºåºï¼‰
            const host = `${CONFIG.bucket}.${CONFIG.endpoint}`;
            const canonicalHeaders = `host:${host}\n` +
                                    `x-amz-content-sha256:${payloadHash}\n` +
                                    `x-amz-date:${isoDate.full}\n`;
            
            const signedHeaders = 'host;x-amz-content-sha256;x-amz-date';
            
            // æ„å»º Canonical Request
            const canonicalRequest = [
                'GET',
                canonicalUri,
                canonicalQueryString,
                canonicalHeaders,
                signedHeaders,
                payloadHash
            ].join('\n');
            
            // è°ƒè¯•è¾“å‡ºï¼ˆå¼€å‘æ—¶ä½¿ç”¨ï¼‰
            console.log('Canonical Request:\n', canonicalRequest);
            
            // è®¡ç®—ç­¾å
            const credentialScope = `${isoDate.short}/${CONFIG.region}/s3/aws4_request`;
            const canonicalRequestHash = uint8ArrayToHex(await sha256(canonicalRequest));
            
            const stringToSign = [
                'AWS4-HMAC-SHA256',
                isoDate.full,
                credentialScope,
                canonicalRequestHash
            ].join('\n');
            
            // æ´¾ç”Ÿç­¾åå¯†é’¥
            const dateKey = await hmacSha256(`AWS4${CONFIG.secretKey}`, isoDate.short);
            const dateRegionKey = await hmacSha256(dateKey, CONFIG.region);
            const dateRegionServiceKey = await hmacSha256(dateRegionKey, 's3');
            const signingKey = await hmacSha256(dateRegionServiceKey, 'aws4_request');
            const signature = uint8ArrayToHex(await hmacSha256(signingKey, stringToSign));
            
            // æ„å»º Authorization Header
            const authHeader = `AWS4-HMAC-SHA256 Credential=${CONFIG.accessKey}/${credentialScope}, SignedHeaders=${signedHeaders}, Signature=${signature}`;
            
            // æ„å»ºå®Œæ•´ URL
            const listUrl = `https://${host}/?${canonicalQueryString}`;
            
            console.log('Request URL:', listUrl);
            console.log('Authorization:', authHeader);
            
            const response = await fetch(listUrl, {
                method: 'GET',
                headers: {
                    'Host': host,
                    'x-amz-date': isoDate.full,
                    'x-amz-content-sha256': payloadHash,
                    'Authorization': authHeader
                }
            });
            
            if (!response.ok) {
                const errorText = await response.text();
                console.error('ListObjects Error Response:', errorText);
                throw new Error(`ListObjectså¤±è´¥: ${response.status} - ${errorText}`);
            }
            
            const xmlText = await response.text();
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            
            // æ£€æŸ¥æ˜¯å¦æœ‰é”™è¯¯
            const errorNode = xmlDoc.querySelector('Error');
            if (errorNode) {
                const errorCode = errorNode.querySelector('Code')?.textContent;
                const errorMessage = errorNode.querySelector('Message')?.textContent;
                throw new Error(`S3 Error: ${errorCode} - ${errorMessage}`);
            }
            
            const contents = xmlDoc.querySelectorAll('Contents');
            const files = [];
            
            contents.forEach(item => {
                const key = item.querySelector('Key')?.textContent;
                const size = parseInt(item.querySelector('Size')?.textContent || '0');
                const lastModified = item.querySelector('LastModified')?.textContent;
                
                if (key && !key.endsWith('/')) {
                    files.push({
                        key: key,
                        size: size,
                        lastModified: lastModified,
                        url: `https://${CONFIG.bucket}.${CONFIG.endpoint}/${encodeURIComponent(key).replace(/%2F/g, '/')}`
                    });
                }
            });
            
            return files;
        }

        // åŠ è½½äº‘ç«¯æ–‡ä»¶åˆ—è¡¨
        async function loadCloudFiles() {
            const fileListEl = document.getElementById('cloud-files-list');
            fileListEl.innerHTML = '<div style="text-align: center; padding: 20px;">åŠ è½½ä¸­...</div>';
            
            try {
                // ä½¿ç”¨ ListObjectsV2 API åˆ—å‡ºç”¨æˆ·ä¸Šä¼ ç›®å½•ä¸‹çš„æ–‡ä»¶
                const prefix = `uploads/${myIp}/`;
                const files = await listObjectsFromRains3(prefix);
                
                if (files.length === 0) {
                    fileListEl.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">æš‚æ— ä¸Šä¼ çš„æ–‡ä»¶</div>';
                    return;
                }
                
                fileListEl.innerHTML = '';
                files.forEach(file => {
                    const fileName = decodeURIComponent(file.key.split('/').pop().replace(/\+/g, ' '));
                    const fileSize = formatFileSize(file.size);
                    const uploadTime = new Date(file.lastModified).toLocaleString();
                    
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div class="file-info">
                            <div class="file-name">${escapeHtml(fileName)}</div>
                            <div class="file-meta">${fileSize} Â· ${uploadTime}</div>
                        </div>
                        <div class="file-actions">
                            <button class="btn-small btn-primary" onclick="window.open('${file.url}', '_blank')">æŸ¥çœ‹</button>
                        </div>
                    `;
                    fileListEl.appendChild(fileItem);
                });
            } catch (error) {
                console.error('åŠ è½½äº‘ç«¯æ–‡ä»¶å¤±è´¥:', error);
                fileListEl.innerHTML = `<div style="text-align: center; color: #f44336; padding: 20px;">åŠ è½½å¤±è´¥: ${error.message}<br><small style="color: #888;">è¯·æ£€æŸ¥æ§åˆ¶å°æŸ¥çœ‹è¯¦ç»†é”™è¯¯ä¿¡æ¯</small></div>`;
            }
        }

        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // æ³¨é”€è´¦æˆ·
        function startAccountDeletion() {
            document.getElementById('verify-ip-display').textContent = myIp;
            document.getElementById('delete-account-modal').style.display = 'flex';
        }

        function closeDeleteAccountModal() {
            document.getElementById('delete-account-modal').style.display = 'none';
            document.getElementById('verify-ip-input').value = '';
        }

        async function confirmDeleteAccount() {
            const inputIp = document.getElementById('verify-ip-input').value.trim();
            
            if (inputIp !== myIp) {
                alert('IPåœ°å€éªŒè¯å¤±è´¥ï¼Œè¯·è¾“å…¥æ­£ç¡®çš„IPåœ°å€');
                return;
            }
            
            if (!confirm('æœ€åç¡®è®¤ï¼šä½ çœŸçš„è¦æ°¸ä¹…åˆ é™¤è´¦æˆ·å—ï¼Ÿæ‰€æœ‰æ•°æ®å°†æ— æ³•æ¢å¤ï¼')) {
                return;
            }
            
            try {
                document.getElementById('loading').textContent = 'æ­£åœ¨æ³¨é”€è´¦æˆ·...';
                document.getElementById('loading').style.display = 'flex';
                document.getElementById('delete-account-modal').style.display = 'none';
                
                // 1. åˆ é™¤ç”¨æˆ·æ•°æ®
                await deleteFromRains3(`users/${myIp}/user_data.json`);
                
                // 2. åˆ é™¤æ‰€æœ‰èŠå¤©è®°å½•
                const chatPrefixes = [`chats/${myIp}/`, `chats/${CONFIG.fileTransferKey}/`];
                for (const prefix of chatPrefixes) {
                    try {
                        const files = await listObjectsFromRains3(prefix);
                        for (const file of files) {
                            await deleteFromRains3(file.key);
                        }
                    } catch (e) {
                        console.log(`æ¸…ç† ${prefix} å¤±è´¥:`, e);
                    }
                }
                
                // 3. åˆ é™¤ä¸Šä¼ çš„æ–‡ä»¶
                try {
                    const uploadFiles = await listObjectsFromRains3(`uploads/${myIp}/`);
                    for (const file of uploadFiles) {
                        await deleteFromRains3(file.key);
                    }
                } catch (e) {
                    console.log('æ¸…ç†ä¸Šä¼ æ–‡ä»¶å¤±è´¥:', e);
                }
                
                alert('è´¦æˆ·å·²æˆåŠŸæ³¨é”€ï¼Œæ‰€æœ‰æ•°æ®å·²åˆ é™¤');
                location.reload();
            } catch (error) {
                alert('æ³¨é”€å¤±è´¥: ' + error.message);
                document.getElementById('loading').style.display = 'none';
            }
        }

        // å…¶ä½™åŸæœ‰å‡½æ•°ä¿æŒä¸å˜...
        async function loadMyUsername() {
            try {
                const userData = await loadUserData();
                myUsername = userData.username || '';
                userPasswordHash = userData.passwordHash || null;
                isPasswordProtected = !!userPasswordHash;
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åå¤±è´¥:', error);
                myUsername = '';
            }
        }

        function updateUsernameDisplay() {
            const usernameEl = document.getElementById('my-username');
            usernameEl.textContent = myUsername || 'æœªè®¾ç½®ç”¨æˆ·å';
        }

        function openEditProfileModal() {
            const usernameInput = document.getElementById('new-username');
            usernameInput.value = myUsername || '';
            updateUsernameLengthTip();
            document.getElementById('edit-profile-modal').style.display = 'flex';
        }

        function closeEditProfileModal() {
            document.getElementById('edit-profile-modal').style.display = 'none';
        }

        function getByteLength(str) {
            return str.split('').reduce((len, char) => {
                return len + (char.charCodeAt(0) > 255 ? 2 : 1);
            }, 0);
        }

        function updateUsernameLengthTip() {
            const input = document.getElementById('new-username');
            const tip = document.getElementById('username-length-tip');
            const length = getByteLength(input.value);
            tip.textContent = `${length}/${CONFIG.maxUsernameLength} å­—ç¬¦`;
            tip.style.color = length > CONFIG.maxUsernameLength ? '#f44336' : '#888';
        }

        function updateRemarkLengthTip() {
            const input = document.getElementById('contact-remark-input');
            const tip = document.getElementById('remark-length-tip');
            const length = getByteLength(input.value);
            tip.textContent = `${length}/${CONFIG.maxRemarkLength} å­—ç¬¦`;
            tip.style.color = length > CONFIG.maxRemarkLength ? '#f44336' : '#888';
        }

        async function saveUsername() {
            const newUsername = document.getElementById('new-username').value.trim();
            if (getByteLength(newUsername) > CONFIG.maxUsernameLength) {
                alert(`ç”¨æˆ·åä¸èƒ½è¶…è¿‡${CONFIG.maxUsernameLength}ä¸ªå­—èŠ‚`);
                return;
            }
            try {
                myUsername = newUsername;
                await saveUserData();
                updateUsernameDisplay();
                closeEditProfileModal();
                alert('ç”¨æˆ·åä¿å­˜æˆåŠŸï¼');
            } catch (error) {
                alert(`ä¿å­˜ç”¨æˆ·åå¤±è´¥: ${error.message}`);
            }
        }

        function openEditRemarkModal(ip) {
            const contactIpDisplay = document.getElementById('contact-ip-display');
            const remarkInput = document.getElementById('contact-remark-input');
            contactIpDisplay.value = ip;
            const contact = contacts.find(item => item.ip === ip);
            remarkInput.value = contact ? contact.remark || '' : '';
            updateRemarkLengthTip();
            document.getElementById('edit-remark-modal').setAttribute('data-ip', ip);
            document.getElementById('edit-remark-modal').style.display = 'flex';
        }

        function closeEditRemarkModal() {
            document.getElementById('edit-remark-modal').style.display = 'none';
            document.getElementById('edit-remark-modal').removeAttribute('data-ip');
        }

        async function saveContactRemark() {
            const ip = document.getElementById('edit-remark-modal').getAttribute('data-ip');
            const newRemark = document.getElementById('contact-remark-input').value.trim();
            if (getByteLength(newRemark) > CONFIG.maxRemarkLength) {
                alert(`å¤‡æ³¨ä¸èƒ½è¶…è¿‡${CONFIG.maxRemarkLength}ä¸ªå­—èŠ‚`);
                return;
            }
            if (!ip) {
                alert('è”ç³»äººIPä¸å­˜åœ¨');
                return;
            }
            try {
                const contactIndex = contacts.findIndex(item => item.ip === ip);
                if (contactIndex !== -1) {
                    contacts[contactIndex].remark = newRemark;
                }
                await saveUserData();
                renderContactList();
                closeEditRemarkModal();
                alert('å¤‡æ³¨ä¿å­˜æˆåŠŸï¼');
            } catch (error) {
                alert(`ä¿å­˜å¤‡æ³¨å¤±è´¥: ${error.message}`);
            }
        }

        function renderContactList() {
            const list = document.getElementById('contact-list');
            list.innerHTML = '';
            
            list.innerHTML += `
                <div class="contact-item file-transfer ${currentChat === CONFIG.fileTransferKey ? 'active' : ''}" 
                     data-ip="${CONFIG.fileTransferKey}" 
                     onclick="switchChat('${CONFIG.fileTransferKey}')">
                    <div class="contact-name">ğŸ“¤ æ–‡ä»¶ä¼ è¾“åŠ©æ‰‹</div>
                    <div class="contact-lastmsg">ç»™è‡ªå·±å‘é€æ¶ˆæ¯/æ–‡ä»¶</div>
                </div>
                <div style="height: 1px; background: #eee; margin: 0 20px;"></div>
            `;
            
            if (contacts.length === 0) {
                list.innerHTML += `
                    <div class="contact-item" style="color: #888; text-align: center; padding: 20px;">
                        æš‚æ— è”ç³»äººï¼Œç‚¹å‡»ä¸‹æ–¹æŒ‰é’®æ·»åŠ 
                    </div>
                `;
            } else {
                contacts.forEach(item => {
                    const ip = item.ip;
                    const remark = item.remark || '';
                    const displayName = remark || ip;
                    
                    list.innerHTML += `
                        <div class="contact-item ${currentChat === ip ? 'active' : ''}" data-ip="${ip}" onclick="switchChat('${ip}')">
                            <div class="contact-name">${displayName} 
                                <span class="remark-edit-btn" onclick="event.stopPropagation(); openEditRemarkModal('${ip}')">âœï¸ å¤‡æ³¨</span>
                            </div>
                            ${remark ? `<div class="contact-remark">IP: ${ip}</div>` : ''}
                            <div class="contact-lastmsg">ç‚¹å‡»å¼€å§‹èŠå¤©</div>
                        </div>
                    `;
                });
            }
            
            if (pendingRequests.length > 0) {
                list.innerHTML += `<div style="padding: 10px 20px; font-size: 14px; color: #ff9800; border-bottom: 1px solid #f0f0f0;">å¾…å¤„ç†ç”³è¯·</div>`;
                pendingRequests.forEach(req => {
                    list.innerHTML += `
                        <div class="contact-item" style="background: #fff3e0;" onclick="handleRequest('${req.from}')">
                            <div class="contact-name">æ¥è‡ª ${req.from} çš„ç”³è¯·</div>
                            <div class="contact-lastmsg">ç‚¹å‡»å¤„ç†</div>
                        </div>
                    `;
                });
            }
        }

        function switchChat(ip) {
            currentChat = ip;
            if (messageSyncTimer) {
                clearInterval(messageSyncTimer);
            }
            
            if (ip === CONFIG.fileTransferKey) {
                document.getElementById('chat-title').textContent = 'æ–‡ä»¶ä¼ è¾“åŠ©æ‰‹';
                document.getElementById('refresh-chat-btn').style.display = 'none';
            } else {
                const contact = contacts.find(item => item.ip === ip);
                const displayTitle = contact && contact.remark ? `${contact.remark} (${ip})` : ip;
                document.getElementById('chat-title').textContent = displayTitle;
                document.getElementById('refresh-chat-btn').style.display = 'inline-block';
                messageSyncTimer = setInterval(loadMessages, CONFIG.messageSyncInterval);
            }
            
            document.getElementById('chat-empty').style.display = 'none';
            document.getElementById('chat-messages').style.display = 'block';
            document.getElementById('chat-input-area').style.display = 'flex';
            document.getElementById('clear-chat-btn').style.display = 'block';
            
            loadMessages();
            renderContactList();
        }

        function openAddContactModal() {
            document.getElementById('add-contact-modal').style.display = 'flex';
        }

        function closeAddContactModal() {
            document.getElementById('add-contact-modal').style.display = 'none';
            document.getElementById('contact-ip').value = '';
        }

        async function sendContactRequest() {
            const targetIp = document.getElementById('contact-ip').value.trim();
            if (!targetIp || targetIp === myIp || isPrivateIp(targetIp)) {
                alert('è¯·è¾“å…¥æœ‰æ•ˆçš„å¯¹æ–¹å¤–ç½‘IP');
                return;
            }
            const isAdded = contacts.some(item => item.ip === targetIp);
            if (isAdded) {
                alert('è¯¥IPå·²åœ¨ä½ çš„è”ç³»äººåˆ—è¡¨ä¸­');
                return;
            }
            try {
                let targetUserData = { contacts: [], pendingRequests: [], lastActive: Date.now(), username: '' };
                const targetDataUrl = `https://${CONFIG.bucket}.${CONFIG.endpoint}/users/${targetIp}/user_data.json`;
                try {
                    const response = await fetch(targetDataUrl);
                    if (response.ok) {
                        targetUserData = await response.json();
                    }
                } catch (e) {
                    await uploadDataToRains3(`users/${targetIp}/user_data.json`, targetUserData);
                }
                targetUserData.pendingRequests = targetUserData.pendingRequests || [];
                targetUserData.pendingRequests.push({ from: myIp, time: Date.now() });
                await uploadDataToRains3(`users/${targetIp}/user_data.json`, targetUserData);
                alert('ç”³è¯·å·²å‘é€ï¼Œè¯·ç­‰å¾…å¯¹æ–¹é€šè¿‡');
                closeAddContactModal();
            } catch (error) {
                alert(`å‘é€ç”³è¯·å¤±è´¥: ${error.message}`);
            }
        }

        async function handleRequest(fromIp) {
            const action = confirm(`æ˜¯å¦åŒæ„ ${fromIp} æ·»åŠ ä½ ä¸ºè”ç³»äººï¼Ÿ`);
            try {
                if (action) {
                    const isExist = contacts.some(item => item.ip === fromIp);
                    if (!isExist) {
                        contacts.push({ ip: fromIp, remark: '' });
                    }
                    
                    const targetDataUrl = `https://${CONFIG.bucket}.${CONFIG.endpoint}/users/${fromIp}/user_data.json`;
                    let targetUserData = { contacts: [], pendingRequests: [], lastActive: Date.now(), username: '' };
                    try {
                        const response = await fetch(targetDataUrl);
                        if (response.ok) {
                            targetUserData = await response.json();
                        }
                    } catch (e) {}
                    
                    targetUserData.contacts = targetUserData.contacts || [];
                    if (Array.isArray(targetUserData.contacts)) {
                        if (typeof targetUserData.contacts[0] === 'string') {
                            targetUserData.contacts = targetUserData.contacts.map(ip => ({ ip, remark: '' }));
                        }
                        const isMyIpExist = targetUserData.contacts.some(item => item.ip === myIp);
                        if (!isMyIpExist) {
                            targetUserData.contacts.push({ ip: myIp, remark: '' });
                        }
                    }
                    
                    await uploadDataToRains3(`users/${fromIp}/user_data.json`, targetUserData);
                }
                pendingRequests = pendingRequests.filter(req => req.from !== fromIp);
                await saveUserData();
                renderContactList();
            } catch (error) {
                alert(`å¤„ç†ç”³è¯·å¤±è´¥: ${error.message}`);
            }
        }

        async function loadMessages() {
            if (!currentChat) return;
            
            const messagesContainer = document.getElementById('chat-messages');
            messagesContainer.innerHTML = '';
            
            try {
                let allMessages = [];
                
                if (currentChat === CONFIG.fileTransferKey) {
                    const chatKey = `chats/${currentChat}/messages.json`;
                    const chatUrl = `https://${CONFIG.bucket}.${CONFIG.endpoint}/${chatKey}`;
                    try {
                        const response = await fetch(chatUrl);
                        if (response.ok) {
                            allMessages = await response.json();
                        }
                    } catch (e) {
                        await uploadDataToRains3(chatKey, []);
                    }
                } else {
                    let myMessages = [];
                    const myChatKey = `chats/${currentChat}/messages.json`;
                    const myChatUrl = `https://${CONFIG.bucket}.${CONFIG.endpoint}/${myChatKey}`;
                    try {
                        const response = await fetch(myChatUrl);
                        if (response.ok) {
                            myMessages = await response.json();
                        }
                    } catch (e) {
                        await uploadDataToRains3(myChatKey, []);
                    }
                    
                    let theirMessages = [];
                    const theirChatKey = `chats/${myIp}/messages.json`;
                    const theirChatUrl = `https://${CONFIG.bucket}.${CONFIG.endpoint}/${theirChatKey}`;
                    try {
                        const response = await fetch(theirChatUrl);
                        if (response.ok) {
                            const allTheirMessages = await response.json();
                            theirMessages = allTheirMessages.filter(msg => 
                                msg.to === myIp && msg.from === currentChat
                            );
                        }
                    } catch (e) {
                        console.log('å¯¹æ–¹æš‚æ— å‘é€ç»™ä½ çš„æ¶ˆæ¯');
                    }
                    
                    const mergedMessages = [...myMessages, ...theirMessages];
                    const uniqueMessages = [];
                    const messageIds = new Set();
                    
                    mergedMessages.forEach(msg => {
                        const msgId = `${msg.time}-${msg.from}-${msg.text.substring(0, 20)}`;
                        if (!messageIds.has(msgId)) {
                            messageIds.add(msgId);
                            uniqueMessages.push(msg);
                        }
                    });
                    
                    allMessages = uniqueMessages.sort((a, b) => a.time - b.time);
                }
                
                allMessages.forEach((msg, index) => renderMessage(msg, index));
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
                
            } catch (error) {
                alert(`åŠ è½½æ¶ˆæ¯å¤±è´¥: ${error.message}`);
            }
        }

        function renderMessage(msg, index) {
            const messagesContainer = document.getElementById('chat-messages');
            const isSent = (currentChat === CONFIG.fileTransferKey) || (msg.from === myIp);
            const messageEl = document.createElement('div');
            
            messageEl.className = `message ${isSent ? 'sent' : 'received'}`;
            messageEl.dataset.index = index;
            let content = msg.text || '';
            
            if (msg.fileUrl) {
                const fileName = msg.fileName || 'æ–‡ä»¶';
                const fileSize = (msg.fileSize / 1024 / 1024).toFixed(2) + 'MB';
                content += `<a href="${msg.fileUrl}" class="message-file" target="_blank" download>${fileName} (${fileSize})</a>`;
            }
            
            const time = new Date(msg.time).toLocaleString();
            messageEl.innerHTML = `
                <div class="message-delete" onclick="deleteSingleMessage(${index})">Ã—</div>
                ${content}
                <div class="message-time">${time}</div>
            `;
            
            messagesContainer.appendChild(messageEl);
        }

        async function deleteSingleMessage(index) {
            if (!currentChat || !confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡æ¶ˆæ¯å—ï¼Ÿï¼ˆä»…åˆ é™¤ä½ è¿™è¾¹çš„è®°å½•ï¼‰')) {
                return;
            }
            
            try {
                if (currentChat === CONFIG.fileTransferKey) {
                    const chatKey = `chats/${currentChat}/messages.json`;
                    const chatUrl = `https://${CONFIG.bucket}.${CONFIG.endpoint}/${chatKey}`;
                    const response = await fetch(chatUrl);
                    
                    let allMessages = [];
                    if (response.ok) {
                        allMessages = await response.json();
                    }
                    
                    allMessages.splice(index, 1);
                    await uploadDataToRains3(chatKey, allMessages);
                } else {
                    const chatKey = `chats/${currentChat}/messages.json`;
                    const chatUrl = `https://${CONFIG.bucket}.${CONFIG.endpoint}/${chatKey}`;
                    const response = await fetch(chatUrl);
                    
                    let myMessages = [];
                    if (response.ok) {
                        myMessages = await response.json();
                    }
                    
                    const allMessages = await loadAllMergedMessages();
                    const msgToDelete = allMessages[index];
                    
                    if (msgToDelete.from === myIp) {
                        const msgIndex = myMessages.findIndex(m => 
                            m.time === msgToDelete.time && m.text === msgToDelete.text
                        );
                        if (msgIndex !== -1) {
                            myMessages.splice(msgIndex, 1);
                            await uploadDataToRains3(chatKey, myMessages);
                        }
                    } else {
                        alert('æ— æ³•åˆ é™¤å¯¹æ–¹å‘é€çš„æ¶ˆæ¯ï¼ˆä»…å¯¹æ–¹å¯åˆ é™¤ï¼‰');
                        return;
                    }
                }
                
                loadMessages();
            } catch (error) {
                alert(`åˆ é™¤æ¶ˆæ¯å¤±è´¥: ${error.message}`);
            }
        }

        async function loadAllMergedMessages() {
            if (currentChat === CONFIG.fileTransferKey) {
                const chatKey = `chats/${currentChat}/messages.json`;
                const chatUrl = `https://${CONFIG.bucket}.${CONFIG.endpoint}/${chatKey}`;
                const response = await fetch(chatUrl);
                return response.ok ? await response.json() : [];
            } else {
                const myChatKey = `chats/${currentChat}/messages.json`;
                const myChatUrl = `https://${CONFIG.bucket}.${CONFIG.endpoint}/${myChatKey}`;
                const myResponse = await fetch(myChatUrl);
                const myMessages = myResponse.ok ? await myResponse.json() : [];
                
                const theirChatKey = `chats/${myIp}/messages.json`;
                const theirChatUrl = `https://${CONFIG.bucket}.${CONFIG.endpoint}/${theirChatKey}`;
                let theirMessages = [];
                try {
                    const theirResponse = await fetch(theirChatUrl);
                    if (theirResponse.ok) {
                        const allTheirMessages = await theirResponse.json();
                        theirMessages = allTheirMessages.filter(msg => 
                            msg.to === myIp && msg.from === currentChat
                        );
                    }
                } catch (e) {}
                
                const merged = [...myMessages, ...theirMessages];
                const unique = [];
                const ids = new Set();
                merged.forEach(msg => {
                    const id = `${msg.time}-${msg.from}-${msg.text.substring(0, 20)}`;
                    if (!ids.has(id)) {
                        ids.add(id);
                        unique.push(msg);
                    }
                });
                return unique.sort((a, b) => a.time - b.time);
            }
        }

        async function clearChatHistory() {
            if (!currentChat || !confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰èŠå¤©è®°å½•å—ï¼Ÿï¼ˆä»…åˆ é™¤ä½ è¿™è¾¹çš„è®°å½•ï¼‰')) {
                return;
            }
            
            try {
                if (currentChat === CONFIG.fileTransferKey) {
                    const chatKey = `chats/${currentChat}/messages.json`;
                    await uploadDataToRains3(chatKey, []);
                } else {
                    const chatKey = `chats/${currentChat}/messages.json`;
                    await uploadDataToRains3(chatKey, []);
                }
                
                loadMessages();
                alert('èŠå¤©è®°å½•å·²æ¸…ç©ºï¼ˆä»…ä½ è¿™è¾¹ï¼‰');
            } catch (error) {
                alert(`æ¸…ç©ºè®°å½•å¤±è´¥: ${error.message}`);
            }
        }

        // S3 V4ç­¾åç”Ÿæˆå‡½æ•°
        function getISO8601Date(date = new Date()) {
            const dt = date.toISOString().replace(/[:\-]|\.\d{3}/g, '');
            return {
                full: dt,
                short: dt.substring(0, 8)
            };
        }

        async function hmacSha256(key, data) {
            const encoder = new TextEncoder();
            const keyData = typeof key === 'string' ? encoder.encode(key) : key;
            const dataData = encoder.encode(data);
            
            const cryptoKey = await crypto.subtle.importKey(
                'raw', keyData, { name: 'HMAC', hash: 'SHA-256' }, false, ['sign']
            );
            return new Uint8Array(await crypto.subtle.sign('HMAC', cryptoKey, dataData));
        }

        async function sha256(data) {
            const encoder = new TextEncoder();
            const dataData = encoder.encode(data);
            return new Uint8Array(await crypto.subtle.digest('SHA-256', dataData));
        }

        function uint8ArrayToHex(arr) {
            return Array.from(arr).map(b => b.toString(16).padStart(2, '0')).join('');
        }

        async function generateS3V4Signature(method, key, payloadHash, isoDate) {
            const service = 's3';
            const region = CONFIG.region;
            
            const dateKey = await hmacSha256(`AWS4${CONFIG.secretKey}`, isoDate.short);
            const dateRegionKey = await hmacSha256(dateKey, region);
            const dateRegionServiceKey = await hmacSha256(dateRegionKey, service);
            const signingKey = await hmacSha256(dateRegionServiceKey, 'aws4_request');
            
            const canonicalUri = `/${encodeURIComponent(key).replace(/%2F/g, '/')}`;
            const canonicalQueryString = '';
            const canonicalHeaders = `host:${CONFIG.bucket}.${CONFIG.endpoint}\nx-amz-content-sha256:${payloadHash}\nx-amz-date:${isoDate.full}\n`;
            const signedHeaders = 'host;x-amz-content-sha256;x-amz-date';
            
            const canonicalRequest = [
                method,
                canonicalUri,
                canonicalQueryString,
                canonicalHeaders,
                signedHeaders,
                payloadHash
            ].join('\n');
            
            const credentialScope = `${isoDate.short}/${region}/${service}/aws4_request`;
            const canonicalRequestHash = uint8ArrayToHex(await sha256(canonicalRequest));
            
            const stringToSign = [
                'AWS4-HMAC-SHA256',
                isoDate.full,
                credentialScope,
                canonicalRequestHash
            ].join('\n');
            
            const signature = uint8ArrayToHex(await hmacSha256(signingKey, stringToSign));
            
            return `AWS4-HMAC-SHA256 Credential=${CONFIG.accessKey}/${credentialScope}, SignedHeaders=${signedHeaders}, Signature=${signature}`;
        }

        async function uploadFileToRains3(file, customKey = null) {
            return new Promise(async (resolve, reject) => {
                const progressEl = document.getElementById('upload-progress');
                const progressFill = document.getElementById('progress-fill');
                progressEl.style.display = 'block';
                progressFill.style.width = '0%';
                
                try {
                    const safeFileName = customKey || `${Date.now()}_${encodeURIComponent(file.name).replace(/%2F/g, '+')}`;
                    const objectKey = `uploads/${myIp}/${safeFileName}`;
                    
                    const isoDate = getISO8601Date();
                    const payloadHash = 'UNSIGNED-PAYLOAD';
                    
                    const authHeader = await generateS3V4Signature('PUT', objectKey, payloadHash, isoDate);
                    const uploadUrl = `https://${CONFIG.bucket}.${CONFIG.endpoint}/${encodeURIComponent(objectKey).replace(/%2F/g, '/')}`;
                    
                    const xhr = new XMLHttpRequest();
                    xhr.open('PUT', uploadUrl, true);
                    
                    xhr.setRequestHeader('x-amz-date', isoDate.full);
                    xhr.setRequestHeader('x-amz-content-sha256', payloadHash);
                    xhr.setRequestHeader('Authorization', authHeader);
                    xhr.setRequestHeader('Content-Type', file.type || 'application/octet-stream');
                    
                    xhr.upload.addEventListener('progress', (e) => {
                        if (e.lengthComputable) {
                            const percent = (e.loaded / e.total) * 100;
                            progressFill.style.width = `${percent}%`;
                        }
                    });
                    
                    xhr.addEventListener('load', () => {
                        progressEl.style.display = 'none';
                        if (xhr.status >= 200 && xhr.status < 300) {
                            resolve({
                                url: uploadUrl,
                                name: file.name,
                                size: file.size
                            });
                        } else {
                            reject(new Error(`ä¸Šä¼ å¤±è´¥: ${xhr.status} ${xhr.statusText}`));
                        }
                    });
                    
                    xhr.addEventListener('error', () => {
                        progressEl.style.display = 'none';
                        reject(new Error('ä¸Šä¼ å¤±è´¥ï¼šç½‘ç»œé”™è¯¯'));
                    });
                    
                    xhr.send(file);
                    
                } catch (error) {
                    progressEl.style.display = 'none';
                    reject(error);
                }
            });
        }

        async function uploadDataToRains3(objectKey, data) {
            const jsonString = JSON.stringify(data);
            const blob = new Blob([jsonString], { type: 'application/json' });
            
            const isoDate = getISO8601Date();
            const payloadHash = 'UNSIGNED-PAYLOAD';
            
            const authHeader = await generateS3V4Signature('PUT', objectKey, payloadHash, isoDate);
            const uploadUrl = `https://${CONFIG.bucket}.${CONFIG.endpoint}/${encodeURIComponent(objectKey).replace(/%2F/g, '/')}`;
            
            const response = await fetch(uploadUrl, {
                method: 'PUT',
                headers: {
                    'x-amz-date': isoDate.full,
                    'x-amz-content-sha256': payloadHash,
                    'Authorization': authHeader,
                    'Content-Type': 'application/json'
                },
                body: blob
            });
            
            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`ä¸Šä¼ å¤±è´¥: ${response.status} ${response.statusText}`);
            }
            
            return {
                url: uploadUrl,
                key: objectKey
            };
        }

        async function deleteFromRains3(objectKey) {
            const isoDate = getISO8601Date();
            const payloadHash = 'UNSIGNED-PAYLOAD';
            
            const authHeader = await generateS3V4Signature('DELETE', objectKey, payloadHash, isoDate);
            const deleteUrl = `https://${CONFIG.bucket}.${CONFIG.endpoint}/${encodeURIComponent(objectKey).replace(/%2F/g, '/')}`;
            
            const response = await fetch(deleteUrl, {
                method: 'DELETE',
                headers: {
                    'x-amz-date': isoDate.full,
                    'x-amz-content-sha256': payloadHash,
                    'Authorization': authHeader
                }
            });
            
            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`åˆ é™¤å¤±è´¥: ${response.status} ${response.statusText}`);
            }
            
            return true;
        }

        async function sendMessage() {
            if (!currentChat) {
                alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªè”ç³»äººæˆ–æ–‡ä»¶ä¼ è¾“åŠ©æ‰‹');
                return;
            }
            
            const input = document.getElementById('message-input');
            const text = input.value.trim();
            const fileInput = document.getElementById('file-input');
            
            if (!text && !fileInput.files.length) {
                return;
            }

            const sendBtn = document.getElementById('send-btn');
            sendBtn.disabled = true;
            sendBtn.textContent = 'å‘é€ä¸­...';

            try {
                let fileUrl = '';
                let fileName = '';
                let fileSize = 0;

                if (fileInput.files.length > 0) {
                    const file = fileInput.files[0];
                    
                    if (file.type.startsWith('image/') && file.size > CONFIG.maxImageSize) {
                        alert('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡3MB');
                        return;
                    }
                    
                    if (file.size > CONFIG.maxFileSize) {
                        alert('æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡2GB');
                        return;
                    }
                    
                    const uploadResult = await uploadFileToRains3(file);
                    fileUrl = uploadResult.url;
                    fileName = uploadResult.name;
                    fileSize = uploadResult.size;
                }

                const msg = {
                    from: myIp,
                    to: (currentChat === CONFIG.fileTransferKey) ? myIp : currentChat,
                    text: text,
                    fileUrl,
                    fileName,
                    fileSize,
                    time: Date.now()
                };

                const chatKey = `chats/${currentChat}/messages.json`;
                let allMessages = [];
                
                try {
                    const chatUrl = `https://${CONFIG.bucket}.${CONFIG.endpoint}/${chatKey}`;
                    const response = await fetch(chatUrl);
                    if (response.ok) {
                        allMessages = await response.json();
                    }
                } catch (e) {}

                allMessages.push(msg);
                await uploadDataToRains3(chatKey, allMessages);

                loadMessages();
                
                input.value = '';
                fileInput.value = '';
                document.getElementById('chat-messages').scrollTop = document.getElementById('chat-messages').scrollHeight;
                
                await saveUserData();

            } catch (error) {
                alert(`å‘é€å¤±è´¥: ${error.message}`);
            } finally {
                sendBtn.disabled = false;
                sendBtn.textContent = 'å‘é€';
            }
        }

        function setupEventListeners() {
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('message-input').addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            window.addEventListener('beforeunload', () => {
                if (messageSyncTimer) clearInterval(messageSyncTimer);
            });
        }

        function setupLengthListeners() {
            const usernameInput = document.getElementById('new-username');
            if (usernameInput) {
                usernameInput.addEventListener('input', updateUsernameLengthTip);
            }
            
            const remarkInput = document.getElementById('contact-remark-input');
            if (remarkInput) {
                remarkInput.addEventListener('input', updateRemarkLengthTip);
            }
        }

        // å¯åŠ¨åº”ç”¨
        init();
    </script>
</body>
</html>
